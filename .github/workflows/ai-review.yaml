name: Devin Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    env:
      DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check PR body for devin-review
        run: |
          echo "PR body: ${{ github.event.pull_request.body }}"
          # devin-reviewã‚’å«ã‚€å ´åˆã€ã¾ãŸã¯ç©ºç™½ã®å ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã§ã‚‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
          echo "Contains devin-review: ${{ contains(github.event.pull_request.body, 'devin-review') || github.event.pull_request.body == '' }}"

      - name: Devin review combined
        # skip-reviewãŒãªã„é™ã‚Šå¸¸ã«å®Ÿè¡Œ
        if: "!contains(github.event.pull_request.body, 'skip-review')"
        run: |
          echo "Starting Devin review process..."
          
          # GitHub CLIãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
          if ! command -v gh &> /dev/null; then
            echo "GitHub CLI not found"
            exit 1
          fi
          
          # ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®æŠ½å‡ºã‚’ä¿®æ­£
          session_comment=$(gh pr view "${{ github.event.number }}" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | head -n 1)

          check_session_status() {
            local session_id="$1"
            echo "Checking session status: $session_id"
            local response
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer $DEVIN_API_KEY")
            
            local status
            status=$(echo "$response" | jq -r '.status // "unknown"')
            echo "Session status: $status"
            echo "$status"
          }

          create_session() {
            local prompt="$1"
            echo "Creating new Devin session..."
            local escaped_prompt=$(echo "$prompt" | jq -R -s .)
            local response
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/sessions" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"prompt\": $escaped_prompt,
                \"playbook_id\": \"playbook-f5454a9ea542482e8805ec43bf8ab201\"
              }")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to create session: $response"
              exit 1
            fi
            local http_body
            http_body=$(echo "$response" | sed '$d')
            local session_id
            session_id=$(echo "$http_body" | jq -r '.session_id')
            if [ -z "$session_id" ] || [ "$session_id" = "null" ]; then
              echo "Failed to get session ID, body = $http_body"
              exit 1
            fi
            echo "Session created with ID: $session_id"
            gh pr comment "${{ github.event.number }}" --body "Devin Session ID: $session_id"
          }

          update_session() {
            local session_id="$1"
            local message="$2"
            echo "Updating Devin session: $session_id"
            
            # ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
            local session_status
            session_status=$(check_session_status "$session_id")
            
            if [ "$session_status" = "exited" ] || [ "$session_status" = "completed" ]; then
              echo "Session has already exited/completed. Will use existing results."
              return 0
            fi
            
            local escaped_message=$(echo "$message" | jq -R -s .)
            local response
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/session/${session_id}/message" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"message\": $escaped_message}")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to update session: $response"
              # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆã¯æ—¢å­˜çµæœã‚’ä½¿ç”¨
                if [[ "$response" == *"already exited"* ]] || [[ "$response" == *"Devin session already exited"* ]]; then
                echo "Session already exited, will use existing results."
                return 0
              fi
              exit 1
            fi
            echo "Session updated successfully"
          }

          instructions="æŒ‡ç¤º: ${{ github.repository }}ã® Pull Request #${{ github.event.number }} ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ä»¥ä¸‹ã‚’è¡Œã£ã¦ãã ã•ã„: 1. Pull Requestã®å¤‰æ›´ç‚¹ã‚’ç¢ºèªã—ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã€ãƒã‚°ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡ŒãŒãªã„ã‹ã‚’ç¢ºèªã™ã‚‹ 2. å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªã¨ã€æ½œåœ¨çš„ãªå•é¡Œç‚¹ã‚„æ”¹å–„ç‚¹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ 3. ç‰¹ã«é‡è¦ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªä¿®æ­£ææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ 4. ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’Pull Requestã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚åˆ¶ç´„äº‹é …: ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚ç°¡æ½”ã§è¦ç‚¹ã‚’çµã£ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚é‡å¤§ãªå•é¡ŒãŒãªã„å ´åˆã‚‚ã€æ”¹å–„ææ¡ˆãŒã‚ã‚Œã°è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚å¿…é ˆ: å›ç­”ã®æœ€åˆã«ã€Œ${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã€ã¨ã„ã†æ¨™é¡Œã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚PRã‚³ãƒ¡ãƒ³ãƒˆã‚‚åŒæ§˜ã®å†…å®¹ã§æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚"

          if [ -z "$session_comment" ]; then
            # åˆå›ã®å ´åˆã¯æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆå…¨ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
            echo "No existing session found, creating new session for full PR review"
            create_session "$instructions"
          else
            # æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆ
            session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
            if [ -z "$session_id" ]; then
              echo "Failed to extract session ID from comment: $session_comment"
              exit 1
            fi
            
            session_status=$(check_session_status "$session_id")
            echo "Existing session status: $session_status"
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Œäº†æ¸ˆã¿ã®å ´åˆã¯æ—¢å­˜çµæœã‚’ä½¿ç”¨
            if [ "$session_status" = "completed" ] || [ "$session_status" = "exited" ]; then
              echo "Session already completed/exited, will use existing results."
            elif [ "$session_status" = "running" ] || [ "$session_status" = "active" ]; then
              echo "Session is still running, will wait for results..."
            else
              echo "Session status unclear, sending review request..."
              update_session "$session_id" "$instructions"
            fi
          fi
          
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«ã¤ã„ã¦ã®è¿½åŠ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          latest_commit_instruction="æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆ ${{ github.event.pull_request.head.sha }} ã®å¤‰æ›´ç‚¹ã«ã¤ã„ã¦è¿½åŠ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚å‰å›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åŠ ãˆã¦ã€æ–°ã—ã„å¤‰æ›´ç‚¹ãŒã‚ã‚Œã°æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’Pull Requestã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚å¿…é ˆ: å›ç­”ã®æœ€åˆã«ã€Œ${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆæ›´æ–°ï¼‰ã€ã¨ã„ã†æ¨™é¡Œã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚"
          update_session "$session_id" "$latest_commit_instruction"
          
  slack-notification:
    runs-on: ubuntu-latest
    needs: code-review
    if: always() && !contains(github.event.pull_request.body, 'skip-review')
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Devin session results
        id: get-results
        run: |
          echo "Getting Devin session results..."
          
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set"
            exit 1
          fi
          
          # æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—
          session_comment=$(gh pr view "${{ github.event.number }}" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | tail -n 1)
          session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
          
          if [ -z "$session_id" ]; then
            echo "Failed to extract session ID"
            echo "results=Devin session not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found session ID: $session_id"
          
          # 3å›ã®è©¦è¡Œã€å„60ç§’å¾…æ©Ÿ
          max_attempts=3
          wait_time=60
          
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}")
            
            if [ $? -eq 0 ] && [ -n "$response" ]; then
              echo "Response received, checking for messages..."
              
              # messagesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              has_messages=$(echo "$response" | jq -r 'has("messages")' 2>/dev/null || echo "false")
              
              if [ "$has_messages" = "true" ]; then
                # devin_messageã‚¿ã‚¤ãƒ—ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
                last_devin_message=$(echo "$response" | jq -r '
                  .messages 
                  | map(select(.type == "devin_message" and .message != null and (.message | length) > 100))
                  | if length > 0 then .[-1].message else null end
                ' 2>/dev/null)
                
                if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ] && [ ${#last_devin_message} -gt 100 ]; then
                  echo "Found devin message (${#last_devin_message} characters)"
                  
                  # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®æ¨™é¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                  if [[ "$last_devin_message" =~ "${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ" ]]; then
                    echo "Found complete review result with proper title format"
                    break
                  else
                    echo "Found devin message but missing expected title format, will continue waiting..."
                  fi
                else
                  echo "No valid devin message found yet"
                fi
              else
                echo "No messages field found in response"
              fi
            else
              echo "Failed to get response or empty response"
            fi
            
            # æœ€å¾Œã®è©¦è¡Œã§ãªã„å ´åˆã¯å¾…æ©Ÿ
            if [ $i -lt $max_attempts ]; then
              echo "Waiting $wait_time seconds before next attempt..."
              sleep $wait_time
            else
              echo "Max attempts reached"
              # æœ€å¾Œã§ã‚‚ä½¿ãˆã‚‹å›ç­”ãŒã‚ã‚Œã°ä½¿ç”¨
              if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ] && [ ${#last_devin_message} -gt 50 ]; then
                echo "Using best available devin message"
                break
              fi
            fi
          done
          
          # æœ€çµ‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
          if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ]; then
            results="$last_devin_message"
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€å¾Œã®devin_messageã‚’å–å¾—ï¼ˆæ¡ä»¶ã‚’ç·©å’Œï¼‰
            results=$(echo "$response" | jq -r '
              if has("messages") then
                .messages 
                | map(select(.type == "devin_message" and .message != null))
                | if length > 0 then .[-1].message else "Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: '"$session_id"'" end
              else
                "Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: '"$session_id"'"
              end
            ' 2>/dev/null || echo "Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: $session_id")
          fi
          
          echo "Final results length: ${#results}"
          echo "Results preview: ${results:0:200}..."
          
          # çµæœãŒç©ºã¾ãŸã¯nullã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$results" ] || [ "$results" = "null" ]; then
            results="Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: $session_id"
          fi
          
          {
            echo "results<<EOF"
            echo "$results"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Slack
        run: |
          echo "Sending notification to Slack..."
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‹ã‚‰ä¸»è¦ãªæƒ…å ±ã‚’æŠ½å‡º
          title=$(echo "${{ steps.get-results.outputs.results }}" | head -n 1 | sed 's/^# *//' | sed 's/^## *//')
          
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç¾è¦³ã«ä½œæˆ
          jq -n \
            --arg text "ğŸ” Devin AI Code Review Completed" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg pr_number "${{ github.event.number }}" \
            --arg pr_title "${{ github.event.pull_request.title }}" \
            --arg repo "${{ github.repository }}" \
            --arg results "${{ steps.get-results.outputs.results }}" \
            --arg title "$title" \
            '{
              text: $text,
              attachments: [
                {
                  color: "good",
                  blocks: [
                    {
                      type: "header",
                      text: {
                        type: "plain_text",
                        text: "ğŸ¤– Devin AI Code Review",
                        emoji: true
                      }
                    },
                    {
                      type: "section",
                      fields: [
                        {
                          type: "mrkdwn",
                          text: ("*Repository:*\n" + $repo)
                        },
                        {
                          type: "mrkdwn",
                          text: ("*PR Number:*\n#" + $pr_number)
                        }
                      ]
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: ("*Pull Request:*\n<" + $pr_url + "|" + $pr_title + ">")
                      }
                    },
                    {
                      type: "divider"
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: "*ğŸ“‹ Review Results:*"
                      }
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: $results
                      }
                    },
                    {
                      type: "context",
                      elements: [
                        {
                          type: "mrkdwn",
                          text: ("ğŸ”— <" + $pr_url + "|View Pull Request> | ğŸ¤– Powered by Devin AI")
                        }
                      ]
                    }
                  ]
                }
              ]
            }' > slack_payload.json
          
          # Slack APIã¸ã®é€ä¿¡
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H 'Content-type: application/json' \
            --data @slack_payload.json \
            "$SLACK_WEBHOOK_URL")
          
          http_status=$(echo "$response" | tail -n 1)
          
          if [ "$http_status" -eq 200 ]; then
            echo "Slack notification sent successfully"
          else
            echo "Failed to send Slack notification. Status: $http_status"
            echo "Response: $(echo "$response" | sed '$d')"
            exit 1
          fi