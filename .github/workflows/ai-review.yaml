name: Devin Code Review

on:
  pull_request:
    types: [opened]  # ÂàùÂõûPR‰ΩúÊàêÊôÇ„ÅÆ„ÅøËá™ÂãïÂÆüË°å
    branches: ['**']

  issue_comment:
    types: [created]   # @devin-ai-review „Ç≥„É°„É≥„Éà„ÅßÊâãÂãï„Éà„É™„Ç¨„Éº
  
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: false
        default: ''

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    env:
      DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      FULL_INSTRUCTIONS: |
        ÊåáÁ§∫: ${{ github.repository }} „ÅÆ Pull Request #${{ github.event.number }} (https://github.com/${{ github.repository }}/pull/${{ github.event.number }})„Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊúÄÂàù„ÅÆÂÆüË°åÔºà„Çª„ÉÉ„Ç∑„Éß„É≥Êú™‰ΩúÊàêÔºâ„Åß„ÅØÂøÖ„ÅöPRÂÖ®‰Ωì„ÇíÈÄöË™≠„Åó„Å¶„Çµ„Éû„É™ÔºàÂ§âÊõ¥„ÅÆË¶ÅÁ¥Ñ„ÄÅÁõÆÁöÑ„ÄÅÂΩ±ÈüøÁØÑÂõ≤Ôºâ„Çí‰ΩúÊàê„Åó„ÄÅ„Åù„ÅÆ‰∏ä„Åß„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„É¨„Éì„É•„Éº„ÅØÊó•Êú¨Ë™û„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂá∫Âäõ„Å´„ÅØÂøÖÈ†à„ÅßÊ¨°„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ: "${{ github.repository }} PR #${{ github.event.number }} „É¨„Éì„É•„ÉºÁµêÊûúÔºàÂÖ®‰ΩìÔºâ"„ÄÇ
        
        **ÈáçË¶Å**: Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÇÑ„ÄåÊâøÁü•„ÅÑ„Åü„Åó„Åæ„Åó„Åü„Äç„Å™„Å©„ÅÆËøîÁ≠î„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇÁõ¥Êé•„É¨„Éì„É•„ÉºÁµêÊûú„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        Âà∂Á¥Ñ„ÉªÂΩ¢ÂºèÔºàÂøÖÈ†àÔºâ:
        - **ÈáçË¶Å**: „Åì„ÅÆPR„ÅßÂ§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´ÔºàFiles changedÔºâ„ÅÆ„Åø„Çí„É¨„Éì„É•„ÉºÂØæË±°„Å®„Åó„ÄÅÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´„ÇÑ„Ç≥„Éº„Éâ„ÅØ‰∏ÄÂàá„É¨„Éì„É•„Éº„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
        - Ë©ï‰æ°„ÅØÁ∞°ÊΩî„Å´„ÄÅË¶ÅÁÇπ„ÇíÊúÄÂàù„Å´Ëø∞„Åπ„Çã„Åì„Å®„ÄÇ
        - ÊåáÊëò„Å´„ÅØ„É©„Éô„É´„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí‰ªò„Åë„Çã„Åì„Å®„ÄÇ‰ΩøÁî®„Åô„Çã„É©„Éô„É´ÔºàÂ∞ë„Å™„Åè„Å®„ÇÇ„Åì„Çå„Çâ„ÇíÂà©Áî®Ôºâ: [Issue]ÔºàÈáçÂ§ß„Å™„Éê„Ç∞„ÇÑÂãï‰Ωú‰∏çËâØÔºâ, [Suggestion]ÔºàÊ©üËÉΩÊîπÂñÑÊèêÊ°àÔºâ, [Nit]ÔºàËªΩÂæÆ„Å™„Çπ„Çø„Ç§„É´/Ë°®Ë®ò‰øÆÊ≠£Ôºâ, [Question]Ôºà‰∏çÊòéÁÇπ„ÉªÁ¢∫Ë™ç‰∫ãÈ†ÖÔºâ.
        - **ÈáçË¶Å**: „É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÅØÊúÄÂ§ß5ÂÄã„Åæ„Åß„Å®„Åó„ÄÅHigh/MediumÂÑ™ÂÖàÂ∫¶„ÅÆÈáçË¶Å„Å™ÊåáÊëò„ÅÆ„Åø„Å´Áµû„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇËªΩÂæÆ„Å™[Nit]„ÇÑ[Question]„ÅØÊúÄÂ∞èÈôê„Å´Áïô„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        - ÂêÑÊåáÊëò„ÅØ„Äå„Éï„Ç°„Ç§„É´„Éë„Çπ:Ë°åÁï™Âè∑ÔºàÂèØËÉΩ„Å™„ÇâÔºâ„Äç„ÄÅÁü≠„ÅÑË™¨Êòé„ÄÅÂøÖË¶Å„Å™„Çâ‰øÆÊ≠£‰æã/„Éë„ÉÉ„ÉÅÊ°à „ÇíÂê´„ÇÅ„Çã„ÄÇ
        - ÈáçË¶ÅÂ∫¶„ÅØ High / Medium / Low „ÅÆ„ÅÑ„Åö„Çå„Åã„Åß„Çø„Ç∞‰ªò„Åë„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        - „Çµ„Éû„É™ÈÉ®ÂàÜ„Åß„ÅØ„ÄÅÂ§âÊõ¥„ÅÆÁõÆÁöÑ„ÄÅÂΩ±ÈüøÁØÑÂõ≤„ÄÅ„ÉÜ„Çπ„Éà„ÅÆË¶ÅÂê¶„ÇíÊòéË®ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        **ÈáçË¶Å**: ÂÄãÂà•„ÅÆ„Ç≥„Éº„Éâ„É¨„Éì„É•„ÉºÊåáÊëò„ÅØ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂøÖ„ÅöÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ:
        ```
        ###REVIEW_START_1###
        [Issue] „Éï„Ç°„Ç§„É´„Éë„Çπ:Ë°åÁï™Âè∑ - ÊåáÊëòÂÜÖÂÆπ
        ÈáçË¶ÅÂ∫¶: High/Medium/Low
        
        **ÁèæÂú®„ÅÆ„Ç≥„Éº„Éâ:**
        ```Ë®ÄË™ûÂêç
        ÂÆüÈöõ„ÅÆ„Ç≥„Éº„ÉâË°åÔºàÂïèÈ°å„ÅÆ„ÅÇ„ÇãÈÉ®ÂàÜÔºâ
        ```
        
        Ë©≥Á¥∞Ë™¨Êòé...
        
        **‰øÆÊ≠£Ê°à:**
        ```Ë®ÄË™ûÂêç
        ‰øÆÊ≠£Âæå„ÅÆ„Ç≥„Éº„Éâ‰æã
        ```
        ###REVIEW_END_1###
        ```
        
        ÂêÑ„É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÅØÈÄ£Áï™Ôºà1, 2, 3...Ôºâ„Çí‰ΩøÁî®„Åó„ÄÅSTART „Å® END „ÅßÂøÖ„ÅöÂõ≤„ÇÄ„Åì„Å®„ÄÇ
        ÂøÖ„Åö„ÄåÁèæÂú®„ÅÆ„Ç≥„Éº„Éâ„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÂÆüÈöõ„ÅÆ„Ç≥„Éº„Éâ„ÇíÂºïÁî®„Åó„ÄÅ„Äå‰øÆÊ≠£Ê°à„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÊîπÂñÑÊ°à„ÇíÁ§∫„Åô„Åì„Å®„ÄÇ
        
        Âá∫ÂäõÊßãÈÄ†Ôºà‰æãÔºâ:
        1) Ë¶ãÂá∫„ÅóÔºàÂøÖÈ†àÔºâ: "„É¨„Éì„É•„ÉºÁµêÊûúÔºàÂÖ®‰ΩìÔºâ"
        2) „Çµ„Éû„É™Ôºà3-5Ë°åÁ®ãÂ∫¶Ôºâ
        3) ÂÄãÂà•„É¨„Éì„É•„ÉºÈ†ÖÁõÆÔºà„Åù„Çå„Åû„Çå ###REVIEW_START_N### „Å® ###REVIEW_END_N### „ÅßÂõ≤„ÇÄÔºâ
        4) ÊúÄÂæå„Å´Á∑èË©ï„Å®ÂÑ™ÂÖàÂ∫¶„ÅÆÈ´ò„ÅÑ‰øÆÊ≠£„É™„Çπ„Éà
      INCREMENTAL_INSTRUCTIONS: |
        ÊåáÁ§∫: ${{ github.repository }} „ÅÆ Pull Request #${{ github.event.number }} „Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**ÈáçË¶Å**: „Åì„ÅÆPR„ÅßÂ§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´ÔºàFiles changedÔºâ„ÅÆ„Åø„ÇíÂØæË±°„Å®„Åó„Å¶„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´„ÇÑ„Ç≥„Éº„Éâ„ÅØ„É¨„Éì„É•„ÉºÂØæË±°Â§ñ„Åß„Åô„ÄÇPR„ÅÆ„ÄåFiles changed„Äç„Çø„Éñ„ÅßÁ¢∫Ë™ç„Åß„Åç„ÇãÂ§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„É¨„Éì„É•„Éº„ÅØÊó•Êú¨Ë™û„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂá∫Âäõ„Å´„ÅØÂøÖÈ†à„ÅßÊ¨°„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ: "„É¨„Éì„É•„ÉºÁµêÊûúÔºàÊõ¥Êñ∞Ôºâ"„ÄÇ
        
        **ÈáçË¶Å**: Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÇÑ„ÄåÊâøÁü•„ÅÑ„Åü„Åó„Åæ„Åó„Åü„Äç„Å™„Å©„ÅÆËøîÁ≠î„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇÁõ¥Êé•„É¨„Éì„É•„ÉºÁµêÊûú„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        Âà∂Á¥Ñ„ÉªÂΩ¢ÂºèÔºàÂøÖÈ†àÔºâ:
        - **ÈáçË¶Å**: „Åì„ÅÆPR„ÅßÂ§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´ÔºàFiles changedÔºâ„ÅÆ„Åø„Çí„É¨„Éì„É•„ÉºÂØæË±°„Å®„Åó„ÄÅÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´„ÇÑ„Ç≥„Éº„Éâ„ÅØ‰∏ÄÂàá„É¨„Éì„É•„Éº„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
        - Ë©ï‰æ°„ÅØÁ∞°ÊΩî„Å´„ÄÅË¶ÅÁÇπ„ÇíÊúÄÂàù„Å´Ëø∞„Åπ„Çã„Åì„Å®„ÄÇ
        - ÊåáÊëò„Å´„ÅØ„É©„Éô„É´„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí‰ªò„Åë„Çã„Åì„Å®„ÄÇ‰ΩøÁî®„Åô„Çã„É©„Éô„É´: [Issue]ÔºàÈáçÂ§ß„Å™„Éê„Ç∞„ÇÑÂãï‰Ωú‰∏çËâØÔºâ, [Suggestion]ÔºàÊ©üËÉΩÊîπÂñÑÊèêÊ°àÔºâ, [Nit]ÔºàËªΩÂæÆ„Å™„Çπ„Çø„Ç§„É´/Ë°®Ë®ò‰øÆÊ≠£Ôºâ, [Question]Ôºà‰∏çÊòéÁÇπ„ÉªÁ¢∫Ë™ç‰∫ãÈ†ÖÔºâ.
        - **ÈáçË¶Å**: „É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÅØÊúÄÂ§ß3ÂÄã„Åæ„Åß„Å®„Åó„ÄÅHigh/MediumÂÑ™ÂÖàÂ∫¶„ÅÆÈáçË¶Å„Å™ÊåáÊëò„ÅÆ„Åø„Å´Áµû„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇËªΩÂæÆ„Å™[Nit]„ÇÑ[Question]„ÅØÊúÄÂ∞èÈôê„Å´Áïô„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        - ÂêÑÊåáÊëò„ÅØ„Äå„Éï„Ç°„Ç§„É´„Éë„Çπ:Ë°åÁï™Âè∑ÔºàÂèØËÉΩ„Å™„ÇâÔºâ„Äç„ÄÅÁü≠„ÅÑË™¨Êòé„ÄÅÂøÖË¶Å„Å™„Çâ‰øÆÊ≠£‰æã/„Éë„ÉÉ„ÉÅÊ°à „ÇíÂê´„ÇÅ„Çã„ÄÇ
        - ÈáçË¶ÅÂ∫¶„ÅØ High / Medium / Low „ÅÆ„ÅÑ„Åö„Çå„Åã„Åß„Çø„Ç∞‰ªò„Åë„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
        **ÈáçË¶Å**: ÂÄãÂà•„ÅÆ„Ç≥„Éº„Éâ„É¨„Éì„É•„ÉºÊåáÊëò„ÅØ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂøÖ„ÅöÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ:
        ```
        ###REVIEW_START_1###
        [Issue] „Éï„Ç°„Ç§„É´„Éë„Çπ:Ë°åÁï™Âè∑ - ÊåáÊëòÂÜÖÂÆπ
        ÈáçË¶ÅÂ∫¶: High/Medium/Low
        
        **ÁèæÂú®„ÅÆ„Ç≥„Éº„Éâ:**
        ```Ë®ÄË™ûÂêç
        ÂÆüÈöõ„ÅÆ„Ç≥„Éº„ÉâË°åÔºàÂïèÈ°å„ÅÆ„ÅÇ„ÇãÈÉ®ÂàÜÔºâ
        ```
        
        Ë©≥Á¥∞Ë™¨Êòé...
        
        **‰øÆÊ≠£Ê°à:**
        ```Ë®ÄË™ûÂêç
        ‰øÆÊ≠£Âæå„ÅÆ„Ç≥„Éº„Éâ‰æã
        ```
        ###REVIEW_END_1###
        ```
        
        ÂêÑ„É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÅØÈÄ£Áï™Ôºà1, 2, 3...Ôºâ„Çí‰ΩøÁî®„Åó„ÄÅSTART „Å® END „ÅßÂøÖ„ÅöÂõ≤„ÇÄ„Åì„Å®„ÄÇ
        ÂøÖ„Åö„ÄåÁèæÂú®„ÅÆ„Ç≥„Éº„Éâ„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÂÆüÈöõ„ÅÆ„Ç≥„Éº„Éâ„ÇíÂºïÁî®„Åó„ÄÅ„Äå‰øÆÊ≠£Ê°à„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÊîπÂñÑÊ°à„ÇíÁ§∫„Åô„Åì„Å®„ÄÇ
        
        Âá∫ÂäõÊßãÈÄ†Ôºà‰æãÔºâ:
        1) Ë¶ãÂá∫„ÅóÔºàÂøÖÈ†àÔºâ: "„É¨„Éì„É•„ÉºÁµêÊûúÔºàÊõ¥Êñ∞Ôºâ"
        2) Â§âÊõ¥ÁÇπ„ÅÆË¶ÅÁ¥ÑÔºà1-3Ë°åÔºâ
        3) ÂÄãÂà•„É¨„Éì„É•„ÉºÈ†ÖÁõÆÔºà„Åù„Çå„Åû„Çå ###REVIEW_START_N### „Å® ###REVIEW_END_N### „ÅßÂõ≤„ÇÄÔºâ
        4) ÂøÖË¶Å„Å™‰øÆÊ≠£Ê°à„Å®ÂÑ™ÂÖàÂ∫¶
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Check if triggered by comment
        id: check-comment
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            body="${{ github.event.comment.body }}"
            echo "Comment body: $body"
            if echo "$body" | grep -q "@devin-ai-review"; then
              echo "trigger=true" >> $GITHUB_OUTPUT
            else
              echo "trigger=false" >> $GITHUB_OUTPUT
            fi
          else
            # ÂØπ‰∫é pull_request ‰∫ã‰ª∂Ôºàopened/synchronizeÔºâÈªòËÆ§ÊâßË°å
            echo "trigger=true" >> $GITHUB_OUTPUT
          fi

      - name: Devin review combined
        if: steps.check-comment.outputs.trigger == 'true' && !contains(github.event.pull_request.body, 'skip-review')
        run: |
          echo "Starting Devin review process..."
          
          # GitHub CLI„ÅåÂà©Áî®ÂèØËÉΩ„ÅãÁ¢∫Ë™ç
          if ! command -v gh &> /dev/null; then
            echo "GitHub CLI not found"
            exit 1
          fi
          
          # PRÁï™Âè∑„ÅÆË®≠ÂÆö„Å®Á¢∫Ë™ç
          echo "Event name: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.number }}"
            echo "Pull request event: PR #$PR_NUMBER"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
            echo "Issue comment event: Issue/PR #$PR_NUMBER"
            # issue_comment„Ç§„Éô„É≥„Éà„ÅßPR„Åã„Å©„ÅÜ„ÅãÁ¢∫Ë™ç
            if [ "${{ github.event.issue.pull_request }}" = "" ]; then
              echo "This comment is on an issue, not a pull request. Exiting."
              exit 0
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            echo "Manual trigger: PR #$PR_NUMBER"
          else
            echo "Unsupported event type: ${{ github.event_name }}"
            exit 1
          fi
          
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "PR number not available. This workflow is designed for Pull Requests."
            echo "Event: ${{ github.event_name }}, Branch: ${{ github.ref_name }}"
            exit 1
          fi
          
          echo "Using PR number: $PR_NUMBER"
          
          # „Çª„ÉÉ„Ç∑„Éß„É≥ID„ÅÆÊäΩÂá∫„Çí‰øÆÊ≠£ÔºàÊúÄÊñ∞„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÂèñÂæóÔºâ
          session_comment=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | head -n 1)

          check_session_status() {
            local session_id="$1"
            echo "Checking session status: $session_id"
            local response
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer $DEVIN_API_KEY")
            
            local status
            status=$(echo "$response" | jq -r '.status // "unknown"')
            echo "Session status: $status"
            echo "$status"
          }

          get_session_snapshot() {
            local session_id="$1"
            echo "Getting snapshot for session: $session_id"
            local response
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer $DEVIN_API_KEY")
            
            local snapshot_id
            snapshot_id=$(echo "$response" | jq -r '.snapshot_id // empty')
            if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "null" ]; then
              echo "Found snapshot ID: $snapshot_id"
              echo "$snapshot_id"
            else
              echo "No snapshot ID found for session $session_id"
              echo ""
            fi
          }

          get_latest_session_info() {
            echo "Searching for latest session from PR comments..."
            local latest_session_comment
            latest_session_comment=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | tail -n 1)
            
            if [ -n "$latest_session_comment" ]; then
              local session_id
              session_id=$(echo "$latest_session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
              echo "Found latest session: $session_id"
              echo "$session_id"
            else
              echo "No previous session found in PR comments"
              echo ""
            fi
          }

          create_session() {
            local prompt="$1"
            local snapshot_id="$2"  # „Ç™„Éó„Ç∑„Éß„Éä„É´„Å™snapshot„Éë„É©„É°„Éº„Çø
            echo "Creating new Devin session..."
            local escaped_prompt=$(echo "$prompt" | jq -R -s .)
            local response
            
            # „É™„ÇØ„Ç®„Çπ„Éà„Éú„Éá„Ç£„ÇíÊßãÁØâÔºàsnapshot_id„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂê´„ÇÅ„ÇãÔºâ
            local request_body
            if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "" ]; then
              echo "Using snapshot ID to inherit context: $snapshot_id"
              request_body=$(jq -n \
                --arg prompt "$prompt" \
                --arg snapshot "$snapshot_id" \
                '{
                  "prompt": $prompt,
                  "snapshot_id": $snapshot,
                  "idempotent": true
                }')
            else
              echo "Creating fresh session without context inheritance"
              request_body=$(jq -n \
                --arg prompt "$prompt" \
                '{
                  "prompt": $prompt,
                  "idempotent": true
                }')
            fi
            
            # idempotent„Éë„É©„É°„Éº„Çø„Çí‰ΩøÁî®„Åó„Å¶„ÄÅÂêå‰∏Ä„Éó„É≠„É≥„Éó„Éà„Åß„ÅÆÈáçË§á„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„ÇíÈò≤Ê≠¢
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/sessions" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"prompt\": $escaped_prompt,
                \"playbook_id\": \"playbook-f5454a9ea542482e8805ec43bf8ab201\"
              }")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to create session: $response"
              exit 1
            fi
            local http_body
            http_body=$(echo "$response" | sed '$d')
            local session_id
            session_id=$(echo "$http_body" | jq -r '.session_id')
            if [ -z "$session_id" ] || [ "$session_id" = "null" ]; then
              echo "Failed to get session ID, body = $http_body"
              exit 1
            fi
            echo "Session created with ID: $session_id"
            gh pr comment "${{ github.event.number }}" --body "Devin Session ID: $session_id"
          }

          update_session() {
            local session_id="$1"
            local message="$2"
            echo "Updating Devin session: $session_id"
            
            # „Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            local session_status
            session_status=$(check_session_status "$session_id")
            
            if [ "$session_status" = "exited" ] || [ "$session_status" = "completed" ]; then
              echo "Session has already exited/completed. Will use existing results."
              return 0
            fi
            
            local escaped_message=$(echo "$message" | jq -R -s .)
            local response
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/session/${session_id}/message" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"message\": $escaped_message}")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to update session: $response"
              # „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÊó¢„Å´ÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊó¢Â≠òÁµêÊûú„Çí‰ΩøÁî®
                if [[ "$response" == *"already exited"* ]] || [[ "$response" == *"Devin session already exited"* ]]; then
                echo "Session already exited, will use existing results."
                return 0
              fi
              exit 1
            fi
            echo "Session updated successfully"
          }

          update_session_with_retry() {
            local session_id="$1"
            local message="$2"
            local max_attempts=3
            local wait_time=30
            
            echo "Updating Devin session with retry logic: $session_id"
            
            for attempt in $(seq 1 $max_attempts); do
              echo "Attempt $attempt/$max_attempts to update session..."
              
              # „Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
              local session_status
              session_status=$(check_session_status "$session_id")
              
              if [ "$session_status" = "exited" ] || [ "$session_status" = "completed" ]; then
                echo "Session has already exited/completed. Will use existing results."
                return 0
              fi
              
              # ÂàùÊúüÂåñ‰∏≠„ÅÆÂ†¥Âêà„ÅØÂæÖÊ©ü
              if [ "$session_status" = "initializing" ] || [ "$session_status" = "starting" ]; then
                echo "Session is still initializing (status: $session_status), waiting ${wait_time}s..."
                sleep $wait_time
                continue
              fi
              
              local escaped_message=$(echo "$message" | jq -R -s .)
              local response
              response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/session/${session_id}/message" \
                -H "Authorization: Bearer $DEVIN_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{\"message\": $escaped_message}")
              local http_status
              http_status=$(echo "$response" | tail -n 1)
              echo "Request info: status code = $http_status"
              
              if [ "$http_status" -eq 200 ]; then
                echo "Session updated successfully"
                return 0
              elif [ "$http_status" -eq 400 ]; then
                local http_body
                http_body=$(echo "$response" | sed '$d')
                echo "400 error: $http_body"
                
                # ÂàùÊúüÂåñ„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÂÜçË©¶Ë°å
                if [[ "$http_body" == *"still initializing"* ]] || [[ "$http_body" == *"initializing"* ]]; then
                  echo "Session still initializing, waiting ${wait_time}s before retry..."
                  sleep $wait_time
                  continue
                fi
                
                # Êó¢„Å´ÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà
                if [[ "$http_body" == *"already exited"* ]] || [[ "$http_body" == *"Devin session already exited"* ]]; then
                  echo "Session already exited, will use existing results."
                  return 0
                fi
                
                echo "Unhandled 400 error: $http_body"
                exit 1
              else
                echo "Failed to update session: $response"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting ${wait_time}s before retry..."
                  sleep $wait_time
                else
                  echo "Max attempts reached, giving up"
                  exit 1
                fi
              fi
            done
          }

          # ÊåáÁ§∫Êñá„ÇíÁí∞Â¢ÉÂ§âÊï∞„Åã„ÇâÂèñÂæóÔºàplaybook_id„ÅÆ‰ª£„Çè„Çä„Å´idempotent„Éë„É©„É°„Éº„Çø„Çí‰ΩøÁî®Ôºâ

          # Êô∫ËÉΩ‰ºöËØùÁÆ°ÁêÜÔºöÂ∞ùËØïÁªßÊâøÁé∞Êúâ‰ºöËØùÊàñ‰ªéÂø´ÁÖßÂàõÂª∫Êñ∞‰ºöËØù
          if [ -z "$session_comment" ]; then
            # Ê≤°ÊúâÊâæÂà∞Áé∞Êúâ‰ºöËØùÔºåÂ∞ùËØïÊü•Êâæ‰πãÂâçÁöÑ‰ºöËØùÂø´ÁÖß
            echo "No existing session found, looking for previous sessions to inherit from..."
            previous_session=$(get_latest_session_info)
            
            if [ -n "$previous_session" ] && [ "$previous_session" != "" ]; then
              echo "Found previous session: $previous_session"
              previous_status=$(check_session_status "$previous_session")
              echo "Previous session status: $previous_status"
              
              # Â¶ÇÊûú‰πãÂâçÁöÑ‰ºöËØùÂ∑≤ÂÆåÊàêÊàñÈÄÄÂá∫ÔºåÂ∞ùËØïËé∑ÂèñÂÖ∂Âø´ÁÖß
              if [ "$previous_status" = "completed" ] || [ "$previous_status" = "exited" ] || [ "$previous_status" = "finished" ]; then
                snapshot_id=$(get_session_snapshot "$previous_session")
                if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "" ]; then
                  echo "Creating new session with inherited context from snapshot: $snapshot_id"
                  create_session "$FULL_INSTRUCTIONS" "$snapshot_id"
                else
                  echo "No snapshot available, creating fresh session"
                  create_session "$FULL_INSTRUCTIONS"
                fi
              else
                echo "Previous session still active ($previous_status), creating fresh session"
                create_session "$FULL_INSTRUCTIONS"
              fi
            else
              echo "No previous sessions found, creating fresh session for full PR review"
              create_session "$FULL_INSTRUCTIONS"
            fi
            
            # create_session ÂÜÖ„Åß export SESSION_ID „Åó„Å¶„ÅÑ„Çã„ÅØ„Åö„Å™„ÅÆ„ÅßË™≠„ÅøËæº„ÇÄ
            if [ -n "$SESSION_ID" ]; then
              echo "SESSION_ID set to $SESSION_ID from create_session"
            else
              # ‰øùÈô©: ÂÜçÂèñÂæó„ÇíË©¶„Åø„Çã
              echo "SESSION_ID not exported, trying to re-read from PR comments..."
              session_comment=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | head -n 1)
              SESSION_ID=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
              export SESSION_ID
            fi
          else
            # Êó¢Â≠ò„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà
            session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
            if [ -z "$session_id" ]; then
              echo "Failed to extract session ID from comment: $session_comment"
              exit 1
            fi
            export SESSION_ID="$session_id"
            
            session_status=$(check_session_status "$SESSION_ID")
            echo "Existing session status: $session_status"
            
            # ÂàùÂõûPR‰ΩúÊàêÊôÇ„ÅØÊó¢Â≠ò„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Å£„Å¶„ÇÇÊñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê
            echo "Creating new session for initial PR review..."
            create_session "$FULL_INSTRUCTIONS"
          fi
          
          # ÂàùÂõûPR‰ΩúÊàêÊôÇ„ÅØÂÖ®‰Ωì„É¨„Éì„É•„Éº„ÅÆ„ÅøÂÆüË°åÔºàËøΩÂä†„ÅÆ„Ç≥„Éü„ÉÉ„Éà„É¨„Éì„É•„Éº„ÅØ‰∏çË¶ÅÔºâ
          echo "Initial PR review completed. For additional reviews, use @devin-ai-review comment."
          
      - name: Set job outputs
        run: |
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          
  slack-notification:
    runs-on: ubuntu-latest
    needs: code-review
    if: success() && !contains(github.event.pull_request.body, 'skip-review')
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Devin session results
        id: get-results
        run: |
          echo "Getting Devin session results..."
          
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set"
            exit 1
          fi
          
          # ÊúÄÊñ∞„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥ID„ÇíÂèñÂæó
          session_comment=$(gh pr view "${{ github.event.number }}" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | tail -n 1)
          session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
          
          if [ -z "$session_id" ]; then
            echo "Failed to extract session ID"
            echo "results=Devin session not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found session ID: $session_id"
          
          # 3Âõû„ÅÆË©¶Ë°å„ÄÅÂêÑ60ÁßíÂæÖÊ©ü
          max_attempts=3
          wait_time=60
          
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            
            # „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}")
            
            if [ $? -eq 0 ] && [ -n "$response" ]; then
              echo "Response received, checking for messages..."
              
              # messages„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
              has_messages=$(echo "$response" | jq -r 'has("messages")' 2>/dev/null || echo "false")
              
              if [ "$has_messages" = "true" ]; then
                # devin_message„Çø„Ç§„Éó„ÅÆÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó
                last_devin_message=$(echo "$response" | jq -r '
                  .messages 
                  | map(select(.type == "devin_message" and .message != null and (.message | length) > 100))
                  | if length > 0 then .[-1].message else null end
                ' 2>/dev/null)
                
                if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ] && [ ${#last_devin_message} -gt 100 ]; then
                  echo "Found devin message (${#last_devin_message} characters)"
                  
                  # „É¨„Éì„É•„ÉºÁµêÊûú„ÅÆÊ®ôÈ°å„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÁ∞°Âåñ„Åï„Çå„ÅüÊ§úÂá∫Ôºâ
                  if [[ "$last_devin_message" =~ "„É¨„Éì„É•„ÉºÁµêÊûú" ]]; then
                    echo "Found complete review result with „É¨„Éì„É•„ÉºÁµêÊûú title"
                    break
                  elif [[ "$last_devin_message" =~ "ÊâøÁü•„ÅÑ„Åü„Åó„Åæ„Åó„Åü" ]] || [[ "$last_devin_message" =~ "Á¢∫Ë™ç„ÅÑ„Åü„Åó„Åæ„Åô" ]] || [[ "$last_devin_message" =~ "„É¨„Éì„É•„Éº„ÅÑ„Åü„Åó„Åæ„Åô" ]]; then
                    echo "Found confirmation message, waiting for actual review results..."
                    echo "Message preview: ${last_devin_message:0:100}..."
                  else
                    echo "Found devin message but missing „É¨„Éì„É•„ÉºÁµêÊûú title, will continue waiting..."
                    echo "Message preview: ${last_devin_message:0:100}..."
                  fi
                else
                  echo "No valid devin message found yet"
                fi
              else
                echo "No messages field found in response"
              fi
            else
              echo "Failed to get response or empty response"
            fi
            
            # ÊúÄÂæå„ÅÆË©¶Ë°å„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÂæÖÊ©ü
            if [ $i -lt $max_attempts ]; then
              echo "Waiting $wait_time seconds before next attempt..."
              sleep $wait_time
            else
              echo "Max attempts reached"
              # ÊúÄÂæå„Åß„ÇÇ‰Ωø„Åà„ÇãÂõûÁ≠î„Åå„ÅÇ„Çå„Å∞‰ΩøÁî®
              if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ] && [ ${#last_devin_message} -gt 50 ]; then
                echo "Using best available devin message"
                break
              fi
            fi
          done
          
          # ÊúÄÁµÇÁöÑ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆö
          if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ]; then
            results="$last_devin_message"
          else
            # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊúÄÂæå„ÅÆdevin_message„ÇíÂèñÂæóÔºàÊù°‰ª∂„ÇíÁ∑©ÂíåÔºâ
            results=$(echo "$response" | jq -r '
              if has("messages") then
                .messages 
                | map(select(.type == "devin_message" and .message != null and (.message | contains("„É¨„Éì„É•„ÉºÁµêÊûú"))))
                | if length > 0 then .[-1].message else "DevinÂàÜÊûê‰∏≠... „Çª„ÉÉ„Ç∑„Éß„É≥ID: '"$session_id"'" end
              else
                "DevinÂàÜÊûê‰∏≠... „Çª„ÉÉ„Ç∑„Éß„É≥ID: '"$session_id"'"
              end
            ' 2>/dev/null || echo "DevinÂàÜÊûê‰∏≠... „Çª„ÉÉ„Ç∑„Éß„É≥ID: $session_id")
          fi
          
          echo "Final results length: ${#results}"
          echo "Results preview: ${results:0:200}..."
          
          # ÁµêÊûú„ÅåÁ©∫„Åæ„Åü„ÅØnull„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
          if [ -z "$results" ] || [ "$results" = "null" ]; then
            results="DevinÂàÜÊûê‰∏≠... „Çª„ÉÉ„Ç∑„Éß„É≥ID: $session_id"
          fi
          
          {
            echo "results<<EOF"
            echo "$results"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Parse and post individual review comments
        run: |
          echo "Parsing Devin review results for individual comments..."
          
          # Devin„ÅÆÁµêÊûú„Åã„ÇâÂÄãÂà•„ÅÆ„É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÇíÊäΩÂá∫
          review_content="${{ steps.get-results.outputs.results }}"
          
          if [ -z "$review_content" ] || [ "$review_content" = "null" ]; then
            echo "No review content available to parse"
            exit 0
          fi
          
          # „É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÇíÊäΩÂá∫„Åô„ÇãÈñ¢Êï∞
          extract_review_items() {
            local content="$1"
            local counter=1
            
            echo "Extracting individual review items..."
            echo "Content length: ${#content}"
            echo "Content preview (first 500 chars):"
            echo "${content:0:500}..."
            
            # ###REVIEW_START_N### „Åã„Çâ ###REVIEW_END_N### „Åæ„Åß„ÅÆÂÜÖÂÆπ„ÇíÊäΩÂá∫
            while true; do
              # ÂêÑ„É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÅÆÈñãÂßã„Å®ÁµÇ‰∫Ü„ÇíÊ§úÁ¥¢
              start_marker="###REVIEW_START_${counter}###"
              end_marker="###REVIEW_END_${counter}###"
              
              echo "Looking for review item $counter..."
              echo "Start marker: $start_marker"
              echo "End marker: $end_marker"
              
              # awk „Çí‰Ωø„Å£„ÅüÂÆâÂÖ®„Å™ÊäΩÂá∫ÊñπÊ≥ïÔºà„Éû„Éº„Ç´„ÉºË°å„ÇÇÂê´„ÇÅ„ÇãÔºâ
              # Â§âÊï∞„ÇíÂÆâÂÖ®„Å´„Ç®„Çπ„Ç±„Éº„Éó„Åó„Å¶‰ΩøÁî®
              review_item=$(echo "$content" | awk -v start="$start_marker" -v end="$end_marker" '
                $0 ~ start { flag=1; print; next }
                $0 ~ end { flag=0; print; next }
                flag { print }
              ')
              
              if [ -z "$review_item" ]; then
                echo "No more review items found. Total extracted: $((counter-1))"
                break
              fi
              
              echo "Found review item $counter:"
              echo "--- Review Item $counter ---"
              # ÂÆâÂÖ®„Å´ÂÜÖÂÆπ„ÇíË°®Á§∫ÔºàÊúÄÂàù„ÅÆ200ÊñáÂ≠ó„ÅÆ„ÅøÔºâ
              echo "$review_item" | head -c 200
              echo "..."
              echo "--- End Review Item $counter ---"
              
              # PR „Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
              echo "Posting review comment #$counter"
              
              # ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åó„Å¶„Ç≥„É°„É≥„ÉàÊú¨Êñá„Çí‰ΩúÊàê
              temp_comment="/tmp/review_comment_${counter}.md"
              
              # „É¨„Éì„É•„ÉºÈ†ÖÁõÆ„Åã„Çâ„Çø„Ç§„Éà„É´„ÇíÊäΩÂá∫ÔºàÊúÄÂàù„ÅÆË°å„Åã„ÇâÔºâ
              review_title=$(echo "$review_item" | head -n 1 | sed 's/^###REVIEW_START_[0-9]*###[[:space:]]*//' 2>/dev/null || echo "")
              
              # ÂÆâÂÖ®„Å´„Ç≥„É°„É≥„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
              {
                echo "$review_item"
                echo ""
                echo "---"
                echo "*Posted by Devin AI Code Review Bot*"
              } > "$temp_comment"
              
              # PR„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
              if ! gh pr comment "${{ needs.code-review.outputs.pr_number }}" --body-file "$temp_comment"; then
                echo "Error: Failed to post review comment #$counter"
                echo "Comment content:"
                cat "$temp_comment"
                echo "Continuing with next review item..."
              else
                echo "Successfully posted review comment #$counter"
              fi
              
              # ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§
              rm -f "$temp_comment"
              
              # Ê¨°„ÅÆ„É¨„Éì„É•„ÉºÈ†ÖÁõÆ„Å∏
              counter=$((counter + 1))
              
              # ÂÆâÂÖ®„ÅÆ„Åü„ÇÅÊúÄÂ§ß50È†ÖÁõÆ„Åæ„Åß
              if [ $counter -gt 50 ]; then
                echo "Maximum review items limit (50) reached"
                break
              fi
              
              # ÂêÑ„Ç≥„É°„É≥„ÉàÊäïÁ®øÈñì„Å´Â∞ë„ÅóÂæÖÊ©ü
              sleep 2
            done
          }
          
          # „É¨„Éì„É•„ÉºÈ†ÖÁõÆ„ÅÆÊäΩÂá∫„Å®ÊäïÁ®ø„ÇíÂÆüË°å
          extract_review_items "$review_content"

      - name: Send to Slack
        run: |
          echo "Sending notification to Slack..."
          
          # „É¨„Éì„É•„ÉºÁµêÊûú„Åã„Çâ‰∏ªË¶Å„Å™ÊÉÖÂ†±„ÇíÊäΩÂá∫ÔºàÂÆâÂÖ®„Å´Âá¶ÁêÜÔºâ
          title=$(echo "${{ steps.get-results.outputs.results }}" | head -n 1 | sed 's/^# *//' | sed 's/^## *//' 2>/dev/null || echo "Devin AI Review Results")
          
          # PRÊÉÖÂ†±„ÇíÂèñÂæó
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ needs.code-review.outputs.pr_number }}"
          PR_NUMBER="${{ needs.code-review.outputs.pr_number }}"
          PR_TITLE="${{ needs.code-review.outputs.pr_title }}"
          REPO="${{ github.repository }}"
          
          echo "PR URL: $PR_URL"
          echo "PR Number: $PR_NUMBER"
          echo "PR Title: $PR_TITLE"
          echo "Repository: $REPO"
          
          # ÁµêÊûú„ÇíÂÆâÂÖ®„Å´Âá¶ÁêÜÔºàÊúÄÂàù„ÅÆ500ÊñáÂ≠ó„ÅÆ„ÅøÔºâ
          results_preview=$(echo "${{ steps.get-results.outputs.results }}" | head -c 500 2>/dev/null || echo "Review completed successfully")
          
          # JSON„Éö„Ç§„É≠„Éº„Éâ„ÇíÁæéË¶≥„Å´‰ΩúÊàê
          jq -n \
            --arg text "Devin AI Code Review Completed" \
            --arg pr_url "$PR_URL" \
            --arg pr_number "$PR_NUMBER" \
            --arg pr_title "$PR_TITLE" \
            --arg repo "$REPO" \
            --arg results "$results_preview" \
            --arg title "$title" \
            '{
              text: $text,
              attachments: [
                {
                  color: "good",
                  blocks: [
                    {
                      type: "header",
                      text: {
                        type: "plain_text",
                        text: "Devin AI Code Review",
                        emoji: true
                      }
                    },
                    {
                      type: "section",
                      fields: [
                        {
                          type: "mrkdwn",
                          text: ("*Repository:*\n" + $repo)
                        },
                        {
                          type: "mrkdwn",
                          text: ("*PR Number:*\n#" + $pr_number)
                        }
                      ]
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: ("*Pull Request:*\n<" + $pr_url + "|" + $pr_title + ">")
                      }
                    },
                    {
                      type: "divider"
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: "*üìã Review Results:*"
                      }
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: $results
                      }
                    },
                    {
                      type: "context",
                      elements: [
                        {
                          type: "mrkdwn",
                          text: ("üîó <" + $pr_url + "|View Pull Request> | ü§ñ Powered by Devin AI")
                        }
                      ]
                    }
                  ]
                }
              ]
            }' > slack_payload.json
          
          # Slack API„Å∏„ÅÆÈÄÅ‰ø°
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H 'Content-type: application/json' \
            --data @slack_payload.json \
            "$SLACK_WEBHOOK_URL")
          
          http_status=$(echo "$response" | tail -n 1)
          
          if [ "$http_status" -eq 200 ]; then
            echo "Slack notification sent successfully"
          else
            echo "Failed to send Slack notification. Status: $http_status"
            echo "Response: $(echo "$response" | sed '$d')"
            exit 1
          fi
