name: Devin Code Review

on:
  pull_request:
    types: [opened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    env:
      DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check PR body for devin-review
        run: |
          echo "PR body: ${{ github.event.pull_request.body }}"
          # devin-reviewを含む場合、または空白の場合（デフォルト）でもレビューを実行
          echo "Contains devin-review: ${{ contains(github.event.pull_request.body, 'devin-review') || github.event.pull_request.body == '' }}"

      - name: Devin review combined
        # skip-reviewがない限り常に実行
        if: "!contains(github.event.pull_request.body, 'skip-review')"
        run: |
          echo "Starting Devin review process..."
          
          # GitHub CLIが利用可能か確認
          if ! command -v gh &> /dev/null; then
            echo "GitHub CLI not found"
            exit 1
          fi
          
          # セッションIDの抽出を修正
          session_comment=$(gh pr view "${{ github.event.number }}" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | head -n 1)

          check_session_status() {
            local session_id="$1"
            echo "Checking session status: $session_id"
            local response
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer $DEVIN_API_KEY")
            
            local status
            status=$(echo "$response" | jq -r '.status // "unknown"')
            echo "Session status: $status"
            echo "$status"
          }

          create_session() {
            local prompt="$1"
            echo "Creating new Devin session..."
            local escaped_prompt=$(echo "$prompt" | jq -R -s .)
            local response
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/sessions" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"prompt\": $escaped_prompt,
                \"playbook_id\": \"playbook-f5454a9ea542482e8805ec43bf8ab201\"
              }")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to create session: $response"
              exit 1
            fi
            local http_body
            http_body=$(echo "$response" | sed '$d')
            local session_id
            session_id=$(echo "$http_body" | jq -r '.session_id')
            if [ -z "$session_id" ] || [ "$session_id" = "null" ]; then
              echo "Failed to get session ID, body = $http_body"
              exit 1
            fi
            echo "Session created with ID: $session_id"
            gh pr comment "${{ github.event.number }}" --body "Devin Session ID: $session_id"
          }

          update_session() {
            local session_id="$1"
            local message="$2"
            echo "Updating Devin session: $session_id"
            
            # まずセッションの状態を確認
            local session_status
            session_status=$(check_session_status "$session_id")
            
            if [ "$session_status" = "exited" ] || [ "$session_status" = "completed" ]; then
              echo "Session has already exited/completed. Creating new session instead."
              create_session "$message"
              return 0
            fi
            
            local escaped_message=$(echo "$message" | jq -R -s .)
            local response
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/session/${session_id}/message" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"message\": $escaped_message}")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to update session: $response"
              # セッションが既に終了している場合は新しいセッションを作成
              if [[ "$response" == *"already exited"* ]]; then
                echo "Session already exited, creating new session..."
                create_session "$message"
                return 0
              fi
              exit 1
            fi
            echo "Session updated successfully"
          }

          # 更新指示内容
          instructions="# 指示

${{ github.repository }}の Pull Request #${{ github.event.number }} をレビューしてください。

レビューでは、以下の作業を行ってください。

1. Pull Requestの変更点を確認し、コードの品質、バグ、セキュリティの問題がないかを確認する
2. 変更内容のサマリと、潜在的な問題点や改善点を簡潔にまとめてください
3. 特に重要な問題がある場合は、具体的な修正提案を含めてください

# 制約事項

* すべてのコメントは日本語で行ってください
* 簡潔で要点を絞ったレビューを心がけてください
* 重大な問題がない場合も、改善提案があれば記載してください"

          if [ -z "$session_comment" ]; then
            # 初回の場合は新セッションを作成（全コミットをレビュー）
            echo "No existing session found, creating new session for full PR review"
            create_session "$instructions"
          else
            # 既存セッションがある場合
            session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
            if [ -z "$session_id" ]; then
              echo "Failed to extract session ID from comment: $session_comment"
              exit 1
            fi
            
            session_status=$(check_session_status "$session_id")
            echo "Existing session status: $session_status"
            
            # セッションが完了済みの場合は最新コミットのレビューを依頼
            if [ "$session_status" = "completed" ] || [ "$session_status" = "exited" ]; then
              echo "Session completed, will use existing results for latest commit review"
              latest_commit_instruction="最新のコミット ${{ github.event.pull_request.head.sha }} の変更点について追加レビューをお願いします。前回のレビューに加えて、新しい変更点があれば指摘してください。"
              create_session "$latest_commit_instruction"
            elif [ "$session_status" = "running" ] || [ "$session_status" = "active" ]; then
              echo "Session is still running, will wait for results..."
            else
              echo "Session status unclear, sending review request..."
              update_session "$session_id" "$instructions"
            fi
          fi
          
  slack-notification:
    runs-on: ubuntu-latest
    needs: code-review
    if: always() && !contains(github.event.pull_request.body, 'skip-review')
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Devin session results
        id: get-results
        run: |
          echo "Getting Devin session results..."
          
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set"
            exit 1
          fi
          
          # 最新のセッションIDを取得
          session_comment=$(gh pr view "${{ github.event.number }}" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | tail -n 1)
          session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
          
          if [ -z "$session_id" ]; then
            echo "Failed to extract session ID"
            echo "results=Devin session not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found session ID: $session_id"
          
          # より効率的な結果取得（最大10回、各15秒）
          max_attempts=10
          
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            
            # メッセージを取得
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}/messages" \
              -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}")
            
            if [ $? -eq 0 ] && [ -n "$response" ]; then
              message_count=$(echo "$response" | jq '.messages | length' 2>/dev/null || echo "0")
              
              if [ "$message_count" -gt 1 ]; then
                last_message=$(echo "$response" | jq -r '.messages[-1].content // ""')
                last_author=$(echo "$response" | jq -r '.messages[-1].author // ""')
                
                # Devinからの回答があるかチェック（100文字以上で十分）
                if [ "$last_author" = "devin" ] && [ ${#last_message} -gt 100 ]; then
                  echo "Found Devin response (${#last_message} characters)"
                  break
                fi
              fi
            fi
            
            if [ $i -eq $max_attempts ]; then
              echo "Max attempts reached, using best available response"
              break
            fi
            
            sleep 15
          done
          
          # 最適なメッセージを選択
          results=$(echo "$response" | jq -r '
            .messages 
            | map(select(.author == "devin" and .content != null and (.content | length) > 50))
            | if length > 0 then .[-1].content else "Devin分析中..." end
          ')
          
          echo "Final results length: ${#results}"
          
          {
            echo "results<<EOF"
            echo "$results"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Slack
        run: |
          echo "Sending notification to Slack..."
          
          # JSONペイロードを安全に作成
          jq -n \
            --arg text "Devin AI Code Review Results for PR #${{ github.event.number }}" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg pr_number "${{ github.event.number }}" \
            --arg pr_title "${{ github.event.pull_request.title }}" \
            --arg results "${{ steps.get-results.outputs.results }}" \
            '{
              text: $text,
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ("*PR:* <" + $pr_url + "|#" + $pr_number + " - " + $pr_title + ">")
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ("*Devin AI Review:*\n```\n" + $results + "\n```")
                  }
                }
              ]
            }' > slack_payload.json
          
          # Slack APIへの送信
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H 'Content-type: application/json' \
            --data @slack_payload.json \
            "$SLACK_WEBHOOK_URL")
          
          http_status=$(echo "$response" | tail -n 1)
          
          if [ "$http_status" -eq 200 ]; then
            echo "Slack notification sent successfully"
          else
            echo "Failed to send Slack notification. Status: $http_status"
            echo "Response: $(echo "$response" | sed '$d')"
            exit 1
          fi