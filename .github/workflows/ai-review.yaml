name: Devin Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: ['**']

  issue_comment:
    types: [created]   # ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
  
  push:
    branches: ['**']
  
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: false
        default: ''

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    env:
      DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      FULL_INSTRUCTIONS: |
        æŒ‡ç¤º: ${{ github.repository }} ã® Pull Request #${{ github.event.number }} ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚æœ€åˆã®å®Ÿè¡Œï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æœªä½œæˆï¼‰ã§ã¯å¿…ãšPRå…¨ä½“ã‚’é€šèª­ã—ã¦ã‚µãƒãƒªï¼ˆå¤‰æ›´ã®è¦ç´„ã€ç›®çš„ã€å½±éŸ¿ç¯„å›²ï¼‰ã‚’ä½œæˆã—ã€ãã®ä¸Šã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚å‡ºåŠ›ã«ã¯å¿…é ˆã§æ¬¡ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å«ã‚ã¦ãã ã•ã„: "${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆå…¨ä½“ï¼‰"ã€‚
        
        åˆ¶ç´„ãƒ»å½¢å¼ï¼ˆå¿…é ˆï¼‰:
        - è©•ä¾¡ã¯ç°¡æ½”ã«ã€è¦ç‚¹ã‚’æœ€åˆã«è¿°ã¹ã‚‹ã“ã¨ã€‚
        - æŒ‡æ‘˜ã«ã¯ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã‚‹ã“ã¨ã€‚ä½¿ç”¨ã™ã‚‹ãƒ©ãƒ™ãƒ«ï¼ˆå°‘ãªãã¨ã‚‚ã“ã‚Œã‚‰ã‚’åˆ©ç”¨ï¼‰: [Issue]ï¼ˆé‡å¤§ãªãƒã‚°ã‚„å‹•ä½œä¸è‰¯ï¼‰, [Suggestion]ï¼ˆæ©Ÿèƒ½æ”¹å–„ææ¡ˆï¼‰, [Nit]ï¼ˆè»½å¾®ãªã‚¹ã‚¿ã‚¤ãƒ«/è¡¨è¨˜ä¿®æ­£ï¼‰, [Question]ï¼ˆä¸æ˜ç‚¹ãƒ»ç¢ºèªäº‹é …ï¼‰.
        - å„æŒ‡æ‘˜ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:è¡Œç•ªå·ï¼ˆå¯èƒ½ãªã‚‰ï¼‰ã€ã€çŸ­ã„èª¬æ˜ã€å¿…è¦ãªã‚‰ä¿®æ­£ä¾‹/ãƒ‘ãƒƒãƒæ¡ˆ ã‚’å«ã‚ã‚‹ã€‚
        - é‡è¦åº¦ã¯ High / Medium / Low ã®ã„ãšã‚Œã‹ã§ã‚¿ã‚°ä»˜ã‘ã—ã¦ãã ã•ã„ã€‚
        - ã‚µãƒãƒªéƒ¨åˆ†ã§ã¯ã€å¤‰æ›´ã®ç›®çš„ã€å½±éŸ¿ç¯„å›²ã€ãƒ†ã‚¹ãƒˆã®è¦å¦ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
        
        å‡ºåŠ›æ§‹é€ ï¼ˆä¾‹ï¼‰:
        1) è¦‹å‡ºã—ï¼ˆå¿…é ˆï¼‰: "${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆå…¨ä½“ï¼‰"
        2) ã‚µãƒãƒªï¼ˆ3-5è¡Œç¨‹åº¦ï¼‰
        3) ä¸»è¦ãªå•é¡Œï¼ˆ[Issue]ï¼‰ä¸€è¦§ï¼ˆå„1-3è¡Œ + å¿…è¦ãªä¿®æ­£ä¾‹ï¼‰
        4) æ”¹å–„ææ¡ˆï¼ˆ[Suggestion]ï¼‰ä¸€è¦§
        5) è»½å¾®ãªæŒ‡æ‘˜ï¼ˆ[Nit]ï¼‰
        6) ç¢ºèªäº‹é …ï¼ˆ[Question]ï¼‰
        7) æœ€å¾Œã«ç·è©•ã¨å„ªå…ˆåº¦ã®é«˜ã„ä¿®æ­£ãƒªã‚¹ãƒˆ
      INCREMENTAL_INSTRUCTIONS: |
        æŒ‡ç¤º: ${{ github.repository }} ã® Pull Request #${{ github.event.number }} ã®æœ€æ–°ã®å¤‰æ›´ï¼ˆå·®åˆ†ï¼‰ã®ã¿ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚åˆå›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¾Œã®å‘¼ã³å‡ºã—ã§ã¯ã€PRå…¨ä½“ã®ã‚µãƒãƒªã¯ä¸è¦ã§ã™ã€‚ä»¥ä¸‹ã®å½¢å¼ã§æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ "${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆæ›´æ–°ï¼‰" ã¨ã—ã¦ãã ã•ã„ã€‚
        
        åˆ¶ç´„ãƒ»å½¢å¼ï¼ˆå¿…é ˆï¼‰:
        - å·®åˆ†ã«å¯¾ã—ã¦ã®ã¿ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã†ã“ã¨ï¼ˆå½±éŸ¿ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¨å¤‰æ›´ç®‡æ‰€ã‚’æ˜è¨˜ï¼‰ã€‚
        - ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯ full_instructions ã¨åŒæ§˜ã«åˆ©ç”¨: [Issue], [Suggestion], [Nit], [Question]
        - å„æŒ‡æ‘˜ã«å¯¾ã—ç°¡æ½”ãªä¿®æ­£ææ¡ˆã‚’å«ã‚ã‚‹ã€‚é‡è¦åº¦ã¯ High / Medium / Low ã‚’ä»˜ä¸ã€‚
        
        å‡ºåŠ›æ§‹é€ ï¼ˆä¾‹ï¼‰:
        1) è¦‹å‡ºã—ï¼ˆå¿…é ˆï¼‰: "${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆæ›´æ–°ï¼‰"
        2) å¤‰æ›´ç‚¹ã®è¦ç´„ï¼ˆ1-3è¡Œï¼‰
        3) æŒ‡æ‘˜ä¸€è¦§ï¼ˆãƒ©ãƒ™ãƒ«ä»˜ãï¼‰
        4) å¿…è¦ãªä¿®æ­£æ¡ˆã¨å„ªå…ˆåº¦
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Check if triggered by comment
        id: check-comment
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            body="${{ github.event.comment.body }}"
            echo "Comment body: $body"
            if echo "$body" | grep -q "@devin-ai-review"; then
              echo "trigger=true" >> $GITHUB_OUTPUT
            else
              echo "trigger=false" >> $GITHUB_OUTPUT
            fi
          else
            # å¯¹äº pull_request äº‹ä»¶ï¼ˆopened/synchronizeï¼‰é»˜è®¤æ‰§è¡Œ
            echo "trigger=true" >> $GITHUB_OUTPUT
          fi

      - name: Devin review combined
        if: steps.check-comment.outputs.trigger == 'true' && !contains(github.event.pull_request.body, 'skip-review')
        run: |
          echo "Starting Devin review process..."
          
          # GitHub CLIãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
          if ! command -v gh &> /dev/null; then
            echo "GitHub CLI not found"
            exit 1
          fi
          
          # PRç•ªå·ã®è¨­å®šã¨ç¢ºèªï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªå€¤ã‚’å–å¾—ï¼‰
          echo "Event name: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.number }}"
            echo "Pull request event: PR #$PR_NUMBER"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
            echo "Issue comment event: Issue/PR #$PR_NUMBER"
            # issue_commentã‚¤ãƒ™ãƒ³ãƒˆã§PRã‹ã©ã†ã‹ç¢ºèª
            if [ "${{ github.event.issue.pull_request }}" = "" ]; then
              echo "This comment is on an issue, not a pull request. Exiting."
              exit 0
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            echo "Manual trigger: PR #$PR_NUMBER"
          else
            # pushã‚¤ãƒ™ãƒ³ãƒˆãªã©ã®å ´åˆã€ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«é–¢é€£ã™ã‚‹PRã‚’æ¤œç´¢
            echo "Searching for PR associated with current branch..."
            CURRENT_BRANCH="${{ github.event.pull_request.head.ref || github.ref_name }}"
            PR_NUMBER=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number // empty')
            echo "Found PR #$PR_NUMBER for branch $CURRENT_BRANCH"
          fi
          
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "PR number not available. This workflow is designed for Pull Requests."
            echo "Event: ${{ github.event_name }}, Branch: ${{ github.ref_name }}"
            exit 1
          fi
          
          echo "Using PR number: $PR_NUMBER"
          
          # ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®æŠ½å‡ºã‚’ä¿®æ­£ï¼ˆæœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼‰
          session_comment=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | head -n 1)

          check_session_status() {
            local session_id="$1"
            echo "Checking session status: $session_id"
            local response
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer $DEVIN_API_KEY")
            
            local status
            status=$(echo "$response" | jq -r '.status // "unknown"')
            echo "Session status: $status"
            echo "$status"
          }

          get_session_snapshot() {
            local session_id="$1"
            echo "Getting snapshot for session: $session_id"
            local response
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer $DEVIN_API_KEY")
            
            local snapshot_id
            snapshot_id=$(echo "$response" | jq -r '.snapshot_id // empty')
            if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "null" ]; then
              echo "Found snapshot ID: $snapshot_id"
              echo "$snapshot_id"
            else
              echo "No snapshot ID found for session $session_id"
              echo ""
            fi
          }

          get_latest_session_info() {
            echo "Searching for latest session from PR comments..."
            local latest_session_comment
            latest_session_comment=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | tail -n 1)
            
            if [ -n "$latest_session_comment" ]; then
              local session_id
              session_id=$(echo "$latest_session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
              echo "Found latest session: $session_id"
              echo "$session_id"
            else
              echo "No previous session found in PR comments"
              echo ""
            fi
          }

          create_session() {
            local prompt="$1"
            local snapshot_id="$2"  # ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªsnapshotãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            echo "Creating new Devin session..."
            local escaped_prompt=$(echo "$prompt" | jq -R -s .)
            local response
            
            # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ§‹ç¯‰ï¼ˆsnapshot_idãŒã‚ã‚‹å ´åˆã¯å«ã‚ã‚‹ï¼‰
            local request_body
            if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "" ]; then
              echo "Using snapshot ID to inherit context: $snapshot_id"
              request_body=$(jq -n \
                --arg prompt "$prompt" \
                --arg snapshot "$snapshot_id" \
                '{
                  "prompt": $prompt,
                  "snapshot_id": $snapshot,
                  "idempotent": true
                }')
            else
              echo "Creating fresh session without context inheritance"
              request_body=$(jq -n \
                --arg prompt "$prompt" \
                '{
                  "prompt": $prompt,
                  "idempotent": true
                }')
            fi
            
            # idempotentãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€åŒä¸€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã®é‡è¤‡ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚’é˜²æ­¢
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/sessions" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"prompt\": $escaped_prompt,
                \"playbook_id\": \"playbook-f5454a9ea542482e8805ec43bf8ab201\"
              }")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to create session: $response"
              exit 1
            fi
            local http_body
            http_body=$(echo "$response" | sed '$d')
            local session_id
            session_id=$(echo "$http_body" | jq -r '.session_id')
            if [ -z "$session_id" ] || [ "$session_id" = "null" ]; then
              echo "Failed to get session ID, body = $http_body"
              exit 1
            fi
            echo "Session created with ID: $session_id"
            gh pr comment "${{ github.event.number }}" --body "Devin Session ID: $session_id"
          }

          update_session() {
            local session_id="$1"
            local message="$2"
            echo "Updating Devin session: $session_id"
            
            # ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
            local session_status
            session_status=$(check_session_status "$session_id")
            
            if [ "$session_status" = "exited" ] || [ "$session_status" = "completed" ]; then
              echo "Session has already exited/completed. Will use existing results."
              return 0
            fi
            
            local escaped_message=$(echo "$message" | jq -R -s .)
            local response
            response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/session/${session_id}/message" \
              -H "Authorization: Bearer $DEVIN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"message\": $escaped_message}")
            local http_status
            http_status=$(echo "$response" | tail -n 1)
            echo "Request info: status code = $http_status"
            if [ "$http_status" -ne 200 ]; then
              echo "Failed to update session: $response"
              # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆã¯æ—¢å­˜çµæœã‚’ä½¿ç”¨
                if [[ "$response" == *"already exited"* ]] || [[ "$response" == *"Devin session already exited"* ]]; then
                echo "Session already exited, will use existing results."
                return 0
              fi
              exit 1
            fi
            echo "Session updated successfully"
          }

          update_session_with_retry() {
            local session_id="$1"
            local message="$2"
            local max_attempts=3
            local wait_time=30
            
            echo "Updating Devin session with retry logic: $session_id"
            
            for attempt in $(seq 1 $max_attempts); do
              echo "Attempt $attempt/$max_attempts to update session..."
              
              # ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
              local session_status
              session_status=$(check_session_status "$session_id")
              
              if [ "$session_status" = "exited" ] || [ "$session_status" = "completed" ]; then
                echo "Session has already exited/completed. Will use existing results."
                return 0
              fi
              
              # åˆæœŸåŒ–ä¸­ã®å ´åˆã¯å¾…æ©Ÿ
              if [ "$session_status" = "initializing" ] || [ "$session_status" = "starting" ]; then
                echo "Session is still initializing (status: $session_status), waiting ${wait_time}s..."
                sleep $wait_time
                continue
              fi
              
              local escaped_message=$(echo "$message" | jq -R -s .)
              local response
              response=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v1/session/${session_id}/message" \
                -H "Authorization: Bearer $DEVIN_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{\"message\": $escaped_message}")
              local http_status
              http_status=$(echo "$response" | tail -n 1)
              echo "Request info: status code = $http_status"
              
              if [ "$http_status" -eq 200 ]; then
                echo "Session updated successfully"
                return 0
              elif [ "$http_status" -eq 400 ]; then
                local http_body
                http_body=$(echo "$response" | sed '$d')
                echo "400 error: $http_body"
                
                # åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å†è©¦è¡Œ
                if [[ "$http_body" == *"still initializing"* ]] || [[ "$http_body" == *"initializing"* ]]; then
                  echo "Session still initializing, waiting ${wait_time}s before retry..."
                  sleep $wait_time
                  continue
                fi
                
                # æ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ
                if [[ "$http_body" == *"already exited"* ]] || [[ "$http_body" == *"Devin session already exited"* ]]; then
                  echo "Session already exited, will use existing results."
                  return 0
                fi
                
                echo "Unhandled 400 error: $http_body"
                exit 1
              else
                echo "Failed to update session: $response"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting ${wait_time}s before retry..."
                  sleep $wait_time
                else
                  echo "Max attempts reached, giving up"
                  exit 1
                fi
              fi
            done
          }

          # æŒ‡ç¤ºæ–‡ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆplaybook_idã®ä»£ã‚ã‚Šã«idempotentãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰

          # æ™ºèƒ½ä¼šè¯ç®¡ç†ï¼šå°è¯•ç»§æ‰¿ç°æœ‰ä¼šè¯æˆ–ä»å¿«ç…§åˆ›å»ºæ–°ä¼šè¯
          if [ -z "$session_comment" ]; then
            # æ²¡æœ‰æ‰¾åˆ°ç°æœ‰ä¼šè¯ï¼Œå°è¯•æŸ¥æ‰¾ä¹‹å‰çš„ä¼šè¯å¿«ç…§
            echo "No existing session found, looking for previous sessions to inherit from..."
            previous_session=$(get_latest_session_info)
            
            if [ -n "$previous_session" ] && [ "$previous_session" != "" ]; then
              echo "Found previous session: $previous_session"
              previous_status=$(check_session_status "$previous_session")
              echo "Previous session status: $previous_status"
              
              # å¦‚æœä¹‹å‰çš„ä¼šè¯å·²å®Œæˆæˆ–é€€å‡ºï¼Œå°è¯•è·å–å…¶å¿«ç…§
              if [ "$previous_status" = "completed" ] || [ "$previous_status" = "exited" ] || [ "$previous_status" = "finished" ]; then
                snapshot_id=$(get_session_snapshot "$previous_session")
                if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "" ]; then
                  echo "Creating new session with inherited context from snapshot: $snapshot_id"
                  create_session "$FULL_INSTRUCTIONS" "$snapshot_id"
                else
                  echo "No snapshot available, creating fresh session"
                  create_session "$FULL_INSTRUCTIONS"
                fi
              else
                echo "Previous session still active ($previous_status), creating fresh session"
                create_session "$FULL_INSTRUCTIONS"
              fi
            else
              echo "No previous sessions found, creating fresh session for full PR review"
              create_session "$FULL_INSTRUCTIONS"
            fi
            
            # create_session å†…ã§ export SESSION_ID ã—ã¦ã„ã‚‹ã¯ãšãªã®ã§èª­ã¿è¾¼ã‚€
            if [ -n "$SESSION_ID" ]; then
              echo "SESSION_ID set to $SESSION_ID from create_session"
            else
              # ä¿é™©: å†å–å¾—ã‚’è©¦ã¿ã‚‹
              echo "SESSION_ID not exported, trying to re-read from PR comments..."
              session_comment=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | head -n 1)
              SESSION_ID=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
              export SESSION_ID
            fi
          else
            # æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆ
            session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
            if [ -z "$session_id" ]; then
              echo "Failed to extract session ID from comment: $session_comment"
              exit 1
            fi
            export SESSION_ID="$session_id"
            
            session_status=$(check_session_status "$SESSION_ID")
            echo "Existing session status: $session_status"
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Œäº†æ¸ˆã¿ã®å ´åˆã¯æ—¢å­˜çµæœã‚’ä½¿ç”¨
            if [ "$session_status" = "completed" ] || [ "$session_status" = "exited" ] || [ "$session_status" = "finished" ]; then
              echo "Session already completed/exited, will use existing results."
            elif [ "$session_status" = "running" ] || [ "$session_status" = "active" ]; then
              echo "Session is still running, will wait for results..."
            elif [ "$session_status" = "suspended" ] || [ "$session_status" = "paused" ]; then
              echo "Session is suspended/paused, sending incremental review request..."
              update_session_with_retry "$SESSION_ID" "$INCREMENTAL_INSTRUCTIONS"
            elif [ "$session_status" = "initializing" ] || [ "$session_status" = "starting" ]; then
              echo "Session is still initializing, will wait for it to be ready..."
              # åˆæœŸåŒ–ä¸­ã®å ´åˆã¯å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ãªã„ï¼ˆçµæœå–å¾—æ™‚ã«å‡¦ç†ï¼‰
            elif [ "$session_status" = "closed" ] || [ "$session_status" = "terminated" ]; then
              echo "Session has been closed/terminated, creating new session with inherited context..."
              snapshot_id=$(get_session_snapshot "$SESSION_ID")
              if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "" ]; then
                echo "Using snapshot from closed session: $snapshot_id"
                create_session "$INCREMENTAL_INSTRUCTIONS" "$snapshot_id"
              else
                echo "No snapshot available from closed session, creating fresh session"
                create_session "$INCREMENTAL_INSTRUCTIONS"
              fi
            else
              echo "Session status unclear ($session_status), sending review request (incremental)..."
              update_session_with_retry "$SESSION_ID" "$INCREMENTAL_INSTRUCTIONS"
            fi
          fi
          
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«ã¤ã„ã¦ã®è¿½åŠ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå¸¸ã«æœ€æ–°å·®åˆ†ã‚’é€ã‚‹ï¼‰
          latest_commit_sha="${{ github.event.pull_request.head.sha || github.sha }}"
          latest_commit_instruction="æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆ ${latest_commit_sha} ã®å¤‰æ›´ç‚¹ã«ã¤ã„ã¦è¿½åŠ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚å·®åˆ†ã®ã¿ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆ[Issue],[Suggestion],[Nit],[Question]ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚å¿…é ˆ: å›ç­”ã®æœ€åˆã«ã€Œ${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆæ›´æ–°ï¼‰ã€ã¨ã„ã†æ¨™é¡Œã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚"
          
          # SESSION_ID ã‚’ä½¿ã£ã¦æ›´æ–°ï¼ˆcreate_session ã®å¾Œã§ã‚‚ SESSION_ID ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ï¼‰
          if [ -z "$SESSION_ID" ]; then
            echo "No SESSION_ID available to send latest commit review"
            exit 1
          fi
          update_session_with_retry "$SESSION_ID" "$latest_commit_instruction"
          
  slack-notification:
    runs-on: ubuntu-latest
    needs: code-review
    if: success() && !contains(github.event.pull_request.body, 'skip-review')
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Devin session results
        id: get-results
        run: |
          echo "Getting Devin session results..."
          
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set"
            exit 1
          fi
          
          # æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—
          session_comment=$(gh pr view "${{ github.event.number }}" --json comments --jq '.comments[] | select(.body | contains("Devin Session ID:")) | .body' | tail -n 1)
          session_id=$(echo "$session_comment" | sed -n 's/.*Devin Session ID: \([^ ]*\).*/\1/p')
          
          if [ -z "$session_id" ]; then
            echo "Failed to extract session ID"
            echo "results=Devin session not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found session ID: $session_id"
          
          # 3å›ã®è©¦è¡Œã€å„60ç§’å¾…æ©Ÿ
          max_attempts=3
          wait_time=60
          
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            response=$(curl -s -X GET "https://api.devin.ai/v1/session/${session_id}" \
              -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}")
            
            if [ $? -eq 0 ] && [ -n "$response" ]; then
              echo "Response received, checking for messages..."
              
              # messagesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              has_messages=$(echo "$response" | jq -r 'has("messages")' 2>/dev/null || echo "false")
              
              if [ "$has_messages" = "true" ]; then
                # devin_messageã‚¿ã‚¤ãƒ—ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
                last_devin_message=$(echo "$response" | jq -r '
                  .messages 
                  | map(select(.type == "devin_message" and .message != null and (.message | length) > 100))
                  | if length > 0 then .[-1].message else null end
                ' 2>/dev/null)
                
                if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ] && [ ${#last_devin_message} -gt 100 ]; then
                  echo "Found devin message (${#last_devin_message} characters)"
                  
                  # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®æ¨™é¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                  if [[ "$last_devin_message" =~ "${{ github.repository }} PR #${{ github.event.number }} ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ" ]]; then
                    echo "Found complete review result with proper title format"
                    break
                  else
                    echo "Found devin message but missing expected title format, will continue waiting..."
                  fi
                else
                  echo "No valid devin message found yet"
                fi
              else
                echo "No messages field found in response"
              fi
            else
              echo "Failed to get response or empty response"
            fi
            
            # æœ€å¾Œã®è©¦è¡Œã§ãªã„å ´åˆã¯å¾…æ©Ÿ
            if [ $i -lt $max_attempts ]; then
              echo "Waiting $wait_time seconds before next attempt..."
              sleep $wait_time
            else
              echo "Max attempts reached"
              # æœ€å¾Œã§ã‚‚ä½¿ãˆã‚‹å›ç­”ãŒã‚ã‚Œã°ä½¿ç”¨
              if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ] && [ ${#last_devin_message} -gt 50 ]; then
                echo "Using best available devin message"
                break
              fi
            fi
          done
          
          # æœ€çµ‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
          if [ "$last_devin_message" != "null" ] && [ -n "$last_devin_message" ]; then
            results="$last_devin_message"
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€å¾Œã®devin_messageã‚’å–å¾—ï¼ˆæ¡ä»¶ã‚’ç·©å’Œï¼‰
            results=$(echo "$response" | jq -r '
              if has("messages") then
                .messages 
                | map(select(.type == "devin_message" and .message != null))
                | if length > 0 then .[-1].message else "Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: '"$session_id"'" end
              else
                "Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: '"$session_id"'"
              end
            ' 2>/dev/null || echo "Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: $session_id")
          fi
          
          echo "Final results length: ${#results}"
          echo "Results preview: ${results:0:200}..."
          
          # çµæœãŒç©ºã¾ãŸã¯nullã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$results" ] || [ "$results" = "null" ]; then
            results="Devinåˆ†æä¸­... ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: $session_id"
          fi
          
          {
            echo "results<<EOF"
            echo "$results"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Slack
        run: |
          echo "Sending notification to Slack..."
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‹ã‚‰ä¸»è¦ãªæƒ…å ±ã‚’æŠ½å‡º
          title=$(echo "${{ steps.get-results.outputs.results }}" | head -n 1 | sed 's/^# *//' | sed 's/^## *//')
          
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç¾è¦³ã«ä½œæˆ
          jq -n \
            --arg text "ğŸ” Devin AI Code Review Completed" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg pr_number "${{ github.event.number }}" \
            --arg pr_title "${{ github.event.pull_request.title }}" \
            --arg repo "${{ github.repository }}" \
            --arg results "${{ steps.get-results.outputs.results }}" \
            --arg title "$title" \
            '{
              text: $text,
              attachments: [
                {
                  color: "good",
                  blocks: [
                    {
                      type: "header",
                      text: {
                        type: "plain_text",
                        text: "ğŸ¤– Devin AI Code Review",
                        emoji: true
                      }
                    },
                    {
                      type: "section",
                      fields: [
                        {
                          type: "mrkdwn",
                          text: ("*Repository:*\n" + $repo)
                        },
                        {
                          type: "mrkdwn",
                          text: ("*PR Number:*\n#" + $pr_number)
                        }
                      ]
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: ("*Pull Request:*\n<" + $pr_url + "|" + $pr_title + ">")
                      }
                    },
                    {
                      type: "divider"
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: "*ğŸ“‹ Review Results:*"
                      }
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: $results
                      }
                    },
                    {
                      type: "context",
                      elements: [
                        {
                          type: "mrkdwn",
                          text: ("ğŸ”— <" + $pr_url + "|View Pull Request> | ğŸ¤– Powered by Devin AI")
                        }
                      ]
                    }
                  ]
                }
              ]
            }' > slack_payload.json
          
          # Slack APIã¸ã®é€ä¿¡
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H 'Content-type: application/json' \
            --data @slack_payload.json \
            "$SLACK_WEBHOOK_URL")
          
          http_status=$(echo "$response" | tail -n 1)
          
          if [ "$http_status" -eq 200 ]; then
            echo "Slack notification sent successfully"
          else
            echo "Failed to send Slack notification. Status: $http_status"
            echo "Response: $(echo "$response" | sed '$d')"
            exit 1
          fi
